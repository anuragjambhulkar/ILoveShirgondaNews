name: ğŸš€ Deploy to Hostasia

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ—ï¸ Build Static Site
        run: node scripts/build-static.js ${{ secrets.VERCEL_API_URL }}

      - name: ğŸ¤ Zip Build Folder
        run: |
          cd out
          zip -r ../shrigonda_news_production.zip .
          cd ..

      - name: ï¿½ Deploy via HTTP (Bypassing FTP)
        run: |
          # Use curl to upload the zip file to our custom PHP handler
          # This runs over standard HTTPS (Port 443), bypassing all FTP firewall issues.
          
          echo "ğŸ“¤ Uploading build to Hostasia..."
          
          # Using -s for silent mode but -w to capture status code
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-Deploy-Token: ${{ secrets.DEPLOY_TOKEN }}" \
            -F "file=@shrigonda_news_production.zip" \
            "${{ secrets.DEPLOY_URL }}/deploy_handler.php")

          # Separate Body and Status Code
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Server Response:"
          echo "$body"

          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Deployment Failed with Status $http_code"
            exit 1
          fi

          echo "âœ… Deployment Successful!"

      - name: ğŸ‰ Success
        run: echo "Deployment finished successfully and server cleaned!"
