name: ğŸš€ Deploy to Hostasia

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: ğŸ—ï¸ Build Static Site
        run: node scripts/build-static.js ${{ secrets.VERCEL_API_URL }}

      - name: ğŸ¤ Zip Build Folder
        run: |
          cd out
          zip -r ../shrigonda_news_production.zip .
          cd ..

      - name: ğŸ“¤ Upload to FTP (LFTP via Command Line)
        run: |
          # Install LFTP (a more robust FTP client)
          sudo apt-get update
          sudo apt-get install -y lftp

          # Upload using LFTP with SSL disabled (Plain FTP) and Active Mode (Passive=false)
          # "debug 5" enabled to monitor the active connection handshakes.
          lftp -e "debug 5; set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode false; cd ${{ secrets.FTP_TARGET_DIR }}; put extract.php; put shrigonda_news_production.zip; bye" -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" ${{ secrets.FTP_SERVER }}

      - name: âš¡ Trigger Extraction & Cleanup
        run: |
          # Trigger extraction and tell the script to delete itself and the zip
          curl -s "${{ secrets.DEPLOY_URL }}/extract.php?run=1&cleanup=1" | grep "Extraction Successful" || (echo "Extraction Failed" && exit 1)

      - name: ğŸ‰ Success
        run: echo "Deployment finished successfully and server cleaned!"
